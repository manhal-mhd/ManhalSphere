version: "3.9"

# Mailu stack for ManhalSphere.
# Copy mailu.env.example to mailu.env and set strong secrets before deployment.

services:
  redis:
    image: redis:alpine
    container_name: mailu-redis
    restart: unless-stopped
    networks:
      - backend

  front:
    image: ghcr.io/mailu/nginx:${MAILU_VERSION:-2.0}
    container_name: mailu-front
    restart: unless-stopped
    env_file:
      - .env
      - mailu.env
    depends_on:
      - admin
      - smtp
      - imap
      - webmail
    networks:
      - proxy
      - backend
    labels:
      - traefik.enable=true
      - traefik.http.routers.mailu.rule=Host(`mail.${BASE_DOMAIN}`)
      - traefik.http.routers.mailu.entrypoints=websecure
      - traefik.http.routers.mailu.tls=true
      - traefik.http.routers.mailu.tls.certresolver=le
      - traefik.http.routers.mailu-root.rule=Host(`mail.${BASE_DOMAIN}`) && Path(`/`)
      - traefik.http.routers.mailu-root.entrypoints=websecure
      - traefik.http.routers.mailu-root.tls=true
      - traefik.http.routers.mailu-root.tls.certresolver=le
      - traefik.http.routers.mailu-root.middlewares=mailu-root-redirect
      - traefik.http.routers.mailu-root.service=noop@internal
      - traefik.http.middlewares.mailu-root-redirect.redirectregex.regex=^https://([^/]+)/$
      - traefik.http.middlewares.mailu-root-redirect.redirectregex.replacement=https://$${1}/webmail/
      - traefik.http.middlewares.mailu-root-redirect.redirectregex.permanent=true
      - traefik.http.services.mailu.loadbalancer.server.port=443
      - traefik.http.services.mailu.loadbalancer.server.scheme=https
    ports:
      - "25:25"
      - "465:465"
      - "587:587"
      - "110:110"
      - "995:995"
      - "143:143"
      - "993:993"
    expose:
      - "80"
    volumes:
      - mailu_certs:/certs
      - mailu_overrides:/overrides

  resolver:
    image: ghcr.io/mailu/unbound:${MAILU_VERSION:-2.0}
    container_name: mailu-resolver
    restart: unless-stopped
    env_file:
      - .env
      - mailu.env
    networks:
      - backend

  admin:
    image: ghcr.io/mailu/admin:${MAILU_VERSION:-2.0}
    container_name: mailu-admin
    restart: unless-stopped
    env_file:
      - .env
      - mailu.env
    dns:
      - 1.1.1.1
      - 1.0.0.1
    depends_on:
      - redis
      - resolver
    networks:
      - backend
    volumes:
      - mailu_data:/data
      - mailu_dkim:/dkim

  imap:
    image: ghcr.io/mailu/dovecot:${MAILU_VERSION:-2.0}
    container_name: mailu-imap
    restart: unless-stopped
    env_file:
      - .env
      - mailu.env
    depends_on:
      - admin
    networks:
      - backend
    volumes:
      - mailu_mail:/mail
      - mailu_overrides:/overrides

  smtp:
    image: ghcr.io/mailu/postfix:${MAILU_VERSION:-2.0}
    container_name: mailu-smtp
    restart: unless-stopped
    env_file:
      - .env
      - mailu.env
    depends_on:
      - admin
      - resolver
    networks:
      - backend
    volumes:
      - mailu_mailqueue:/queue
      - mailu_overrides:/overrides

  antispam:
    image: ghcr.io/mailu/rspamd:${MAILU_VERSION:-2.0}
    container_name: mailu-antispam
    restart: unless-stopped
    env_file:
      - .env
      - mailu.env
    depends_on:
      - admin
      - redis
    networks:
      - backend
    volumes:
      - mailu_filter:/var/lib/rspamd
      - mailu_overrides:/overrides

  antivirus:
    image: ghcr.io/mailu/clamav:${MAILU_VERSION:-2.0}
    container_name: mailu-antivirus
    restart: unless-stopped
    networks:
      - backend
    volumes:
      - mailu_filter:/data

  webmail:
    image: ghcr.io/mailu/webmail:${MAILU_VERSION:-2.0}
    container_name: mailu-webmail
    restart: unless-stopped
    env_file:
      - .env
      - mailu.env
    depends_on:
      - admin
    networks:
      - backend
    volumes:
      - mailu_webmail:/data

networks:
  proxy:
    external: true
    name: proxy
  backend:
    external: true
    name: backend

volumes:
  mailu_data:
  mailu_dkim:
  mailu_mail:
  mailu_mailqueue:
  mailu_filter:
  mailu_certs:
  mailu_webmail:
  mailu_overrides:
